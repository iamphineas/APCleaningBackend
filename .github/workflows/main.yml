name: .NET API Build, Test & Security

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  DOTNET_VERSION: '8.0.x'
  TEST_PROJECT_PATH: './APCleaningBackendTest'
  API_PROJECT_PATH: './APCleaningBackend/APCleaningBackend.csproj'

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore projects
        run: |
          dotnet restore ${{ env.API_PROJECT_PATH }}
          dotnet restore ${{ env.TEST_PROJECT_PATH }}

      - name: Build projects
        run: |
          dotnet build ${{ env.API_PROJECT_PATH }} --configuration Release --no-restore
          dotnet build ${{ env.TEST_PROJECT_PATH }} --configuration Release --no-restore

      - name: Run unit tests
        run: |
          dotnet test ${{ env.TEST_PROJECT_PATH }} \
            --configuration Release \
            --no-build \
            --verbosity normal \
            --collect:"XPlat Code Coverage" \
            --results-directory ./TestResults \
            --logger "trx;LogFileName=test-results.trx"

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: ./TestResults/**/*

      - name: Publish API
        run: dotnet publish ${{ env.API_PROJECT_PATH }} --configuration Release --output ./publish --no-restore

      - name: Upload publish artifact
        uses: actions/upload-artifact@v4
        with:
          name: dotnet-publish
          path: ./publish

  snyk-scan:
    runs-on: ubuntu-latest
    needs: build-and-test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Snyk CLI
        run: npm install -g snyk

      # ðŸ‘‡ The key fix â€” run from within the API directory, no --file or wildcards
      - name: Run Snyk Scan
        working-directory: ./APCleaningBackend
        run: snyk test --severity-threshold=high --json-file-output=../snyk-report.json
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        continue-on-error: true

      - name: Upload Snyk report
        uses: actions/upload-artifact@v4
        with:
          name: snyk-report
          path: ./snyk-report.json

  codeql-analysis:
    runs-on: ubuntu-latest
    needs: build-and-test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: csharp

      - name: Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: Analyze
        uses: github/codeql-action/analyze@v3

  deploy-to-azure:
    runs-on: ubuntu-latest
    needs: [build-and-test, snyk-scan, codeql-analysis]
    environment:
      name: Production
      url: ${{ steps.deploy-to-webapp.outputs.webapp-url }}

    steps:
      - name: Download publish artifact
        uses: actions/download-artifact@v4
        with:
          name: dotnet-publish
          path: ./publish

      - name: Login to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy to Azure Web App
        id: deploy-to-webapp
        uses: azure/webapps-deploy@v3
        with:
          app-name: APCleaningBackend20251029193438
          package: ./publish

      - name: Run smoke test
        run: |
          sleep 30
          curl -f ${{ steps.deploy-to-webapp.outputs.webapp-url }}/health || exit 0
        continue-on-error: true

      - name: Logout Azure
        run: az logout
        if: always()
